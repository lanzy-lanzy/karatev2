{% extends "base.html" %}

{% block title %}{% if match %}Edit Match{% else %}Create Match{% endif %} - BlackCobra Karate Club{% endblock %}

{% block page_title %}{% if match %}Edit Match{% else %}Create Match{% endif %}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">
                {% if match %}Edit Match{% else %}Create New Match{% endif %}
            </h2>
            <p class="text-sm text-gray-500 mt-1">
                {% if match %}Update match details and judge assignments{% else %}Set up a new match between two competitors{% endif %}
            </p>
        </div>
        
        <form method="post" 
              {% if match %}action="{% url 'admin_match_edit' match.id %}"{% else %}action="{% url 'admin_match_add' %}"{% endif %}
              hx-post="{% if match %}{% url 'admin_match_edit' match.id %}{% else %}{% url 'admin_match_add' %}{% endif %}"
              hx-swap="innerHTML"
              hx-target="body"
              class="p-6 space-y-6">
            {% csrf_token %}
            
            <!-- Event Selection -->
            <div>
                <label for="event" class="block text-sm font-medium text-gray-700 mb-1">Event *</label>
                <select name="event" id="event" required
                        class="w-full px-4 py-3 min-h-[44px] border {% if form.event.errors %}border-red-500{% else %}border-gray-300{% endif %} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    <option value="">Select an event</option>
                    {% for event in events %}
                    <option value="{{ event.id }}" {% if form.event.value == event.id|stringformat:"s" %}selected{% endif %}>
                        {{ event.name }} ({{ event.event_date|date:"M d, Y" }})
                    </option>
                    {% endfor %}
                </select>
                {% if form.event.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.event.errors.0 }}</p>
                {% endif %}
            </div>
            
            <!-- Match Type -->
            <div>
                <label for="match_type" class="block text-sm font-medium text-gray-700 mb-1">Match Type</label>
                <select name="match_type" id="match_type"
                        class="w-full px-4 py-3 min-h-[44px] border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    {% for code, label in match_types %}
                    <option value="{{ code }}" {% if form.match_type.value == code %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Promotion Match Checkbox -->
            <div class="flex items-center">
                <input type="checkbox" name="is_promotion_match" id="is_promotion_match" value="true"
                       {% if form.is_promotion_match.value %}checked{% endif %}
                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="is_promotion_match" class="ml-2 block text-sm text-gray-900">
                    Promotion Match <span class="text-gray-500 text-xs">(Judges will score all match types)</span>
                </label>
            </div>
            
            <!-- Competitors -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="competitor1" class="block text-sm font-medium text-gray-700 mb-1">Competitor 1 *</label>
                    <select name="competitor1" id="competitor1" required
                            class="w-full px-4 py-3 min-h-[44px] border {% if form.competitor1.errors %}border-red-500{% else %}border-gray-300{% endif %} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        <option value="">Select competitor</option>
                        {% for trainee in trainees %}
                        <option value="{{ trainee.id }}" {% if form.competitor1.value == trainee.id|stringformat:"s" %}selected{% endif %}>
                            {{ trainee.profile.user.get_full_name|default:trainee.profile.user.username }} - {{ trainee.get_belt_rank_display }} ({{ trainee.weight }}kg)
                        </option>
                        {% endfor %}
                    </select>
                    {% if form.competitor1.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.competitor1.errors.0 }}</p>
                    {% endif %}
                </div>
                
                <div>
                    <label for="competitor2" class="block text-sm font-medium text-gray-700 mb-1">Competitor 2 *</label>
                    <select name="competitor2" id="competitor2" required
                            class="w-full px-4 py-3 min-h-[44px] border {% if form.competitor2.errors %}border-red-500{% else %}border-gray-300{% endif %} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                        <option value="">Select competitor</option>
                        {% for trainee in trainees %}
                        <option value="{{ trainee.id }}" {% if form.competitor2.value == trainee.id|stringformat:"s" %}selected{% endif %}>
                            {{ trainee.profile.user.get_full_name|default:trainee.profile.user.username }} - {{ trainee.get_belt_rank_display }} ({{ trainee.weight }}kg)
                        </option>
                        {% endfor %}
                    </select>
                    {% if form.competitor2.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.competitor2.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Scheduled Time -->
            <div>
                <label for="scheduled_time" class="block text-sm font-medium text-gray-700 mb-1">Scheduled Time *</label>
                <input type="datetime-local" name="scheduled_time" id="scheduled_time" required
                       value="{{ form.scheduled_time.value|default:'' }}"
                       class="w-full px-4 py-3 min-h-[44px] border {% if form.scheduled_time.errors %}border-red-500{% else %}border-gray-300{% endif %} rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                {% if form.scheduled_time.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.scheduled_time.errors.0 }}</p>
                {% endif %}
            </div>
            
            <!-- Judges -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Assign Judges <span class="text-red-600">*</span> (Minimum 3)</label>
                <div class="space-y-2 max-h-48 overflow-y-auto border {% if form.judges.errors %}border-red-500{% else %}border-gray-300{% endif %} rounded-lg p-3">
                    {% for judge in judges %}
                    <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                        <input type="checkbox" name="judges" value="{{ judge.id }}"
                               {% if judge.id|stringformat:"s" in form.judges.value %}checked{% endif %}
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <span class="ml-3 text-sm text-gray-700">
                            {{ judge.profile.user.get_full_name|default:judge.profile.user.username }}
                            <span class="text-gray-500">({{ judge.get_certification_level_display }})</span>
                        </span>
                    </label>
                    {% empty %}
                    <p class="text-sm text-gray-500 italic">No active judges available</p>
                    {% endfor %}
                </div>
                {% if form.judges.errors %}
                <p class="mt-1 text-sm text-red-600">{{ form.judges.errors.0 }}</p>
                {% else %}
                <p class="mt-1 text-xs text-gray-500">Select at least 3 judges to officiate this match</p>
                {% endif %}
            </div>
            
            {% if match %}
            <!-- Status (only for edit) -->
            <div>
                <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select name="status" id="status"
                        class="w-full px-4 py-3 min-h-[44px] border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    <option value="scheduled" {% if form.status.value == 'scheduled' %}selected{% endif %}>Scheduled</option>
                    <option value="ongoing" {% if form.status.value == 'ongoing' %}selected{% endif %}>Ongoing</option>
                    <option value="completed" {% if form.status.value == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="cancelled" {% if form.status.value == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>
            {% endif %}
            
            <!-- Notes -->
            <div>
                <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                <textarea name="notes" id="notes" rows="3"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                          placeholder="Optional notes about this match">{{ form.notes.value|default:'' }}</textarea>
            </div>
            
            <!-- Form Actions -->
            <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-200">
                <a href="{% url 'admin_matchmaking' %}" 
                   class="px-4 py-3 min-h-[44px] text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors inline-flex items-center justify-center">
                    Cancel
                </a>
                <button type="submit"
                        class="px-4 py-3 min-h-[44px] text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors inline-flex items-center justify-center">
                    {% if match %}Update Match{% else %}Create Match{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
